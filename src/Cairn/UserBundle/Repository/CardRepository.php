<?php

namespace Cairn\UserBundle\Repository;

use Doctrine\ORM\QueryBuilder;

/**
 * CardRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CardRepository extends \Doctrine\ORM\EntityRepository
{

    public function findAvailableCardWithCode($code)
    {
        $cb = $this->createQueryBuilder('c');                  
        $this->whereAvailable($cb);
        $cb->andWhere('c.code = :code')
            ->setParameter('code',$code)
            ->setMaxResults(1);

        $result = $cb->getQuery()->getOneOrNullResult();
        return $result;
    }

    public function findAvailableCards()
    {
        $cb = $this->createQueryBuilder('c');                  

        $this->whereAvailable($cb);
        $result = $cb->getQuery()->getResult();
        return $result;
    }

    public function whereAvailable(QueryBuilder $cb)
    {
        $cb->leftJoin('c.users','u')
            ->andWhere('u.card is NULL');
 
        return $this;
    }

    public function whereExpiresBefore(QueryBuilder $cb, $date)
    {
        $cb->andWhere('c.expirationDate <= :expirationDate')
           ->setParameter('expirationDate',$date); 
        return $this;
    }
}
